using System;
using System.IO;
using System.Text;
using System.Drawing;
using System.Threading;
using System.Diagnostics;
using System.Windows.Forms;
using System.ComponentModel;
using System.Collections.Generic;
using Registry_Manager;
using Virtual_File_System_Library;
using System.Drawing.Imaging;
using System.Drawing.Drawing2D;
using CD_Sync.Properties;
using CustomControls;

namespace CD_Sync
{
    internal partial class WndMain : Form
    {
        private List<ImageCategory> categories;
        private VFS virtualFS;
        private Stack<UInt32> backChain, forwardChain;
        private ListEntry globalImageListEntry;
        private Int32 tempInteger;
        private UInt32 currentLocationID, totalInvisibleObjects;
        private UInt64 selectionSize;
        private FileTypeManager fTypeManager;
        private Thread threadImageSourceDriveTypeQuerier;
        private bool asked, imageSourceOnline;

        public WndMain()
        {
            InitializeComponent();

            categories = CategoryManager.GetAllCategories();

            treeImageBrowser.ImageList = new ImageList();
            treeImageBrowser.ImageList.Images.Add(Properties.Resources.blankcd);
            treeImageBrowser.ImageList.Images.Add(Properties.Resources.FillDownHS);
            treeImageBrowser.ImageList.Images.Add(Properties.Resources.FillRightHS);
            treeImageBrowser.HideSelection = false;
            treeImageBrowser.PathSeparator = "\\";

            lViewVFSBrowser.LargeImageList = new ImageList();
            lViewVFSBrowser.LargeImageList.ColorDepth = ColorDepth.Depth32Bit;
            lViewVFSBrowser.LargeImageList.ImageSize = new Size(32, 32);

            lViewVFSBrowser.SmallImageList = new ImageList();
            lViewVFSBrowser.SmallImageList.ColorDepth = ColorDepth.Depth32Bit;
            lViewVFSBrowser.SmallImageList.ImageSize = new Size(16, 16);
            lViewVFSBrowser.AutoArrange = true;
            AddDetailColumns();

            fTypeManager = new FileTypeManager();

            backChain = new Stack<UInt32>(10);
            forwardChain = new Stack<UInt32>(10);
            virtualFS = new VFS();
            
            asked = false;
        }

        private void mainWnd_Load(object sender, EventArgs e)
        {
            RefreshImageBrowser();
            if (AppSettingsManager.ShowExtendedPropertiesPanel)
            {
                viewSplitter3.Panel2Collapsed = false;
                ClearExtendedPropertiesPanel();
            }
        }

        #region treeImageBrowser handler code

        private void RefreshImageBrowser()
        {
            ExtendedTreeNode tempExtendedTreeNode = new ExtendedTreeNode();
            ListEntry tempListEntry;

            treeImageBrowser.Nodes.Clear();
            treeImageBrowser.Nodes.Add(new ExtendedTreeNode(ExtendedTreeNodeType.NodeTypeSuperCategory, "Categorized Images", 0, 0));
            treeImageBrowser.Nodes.Add(new ExtendedTreeNode(ExtendedTreeNodeType.NodeTypeSuperCategory, "Uncategorized Images", 0, 0));
            treeImageBrowser.Nodes.Add(new ExtendedTreeNode(ExtendedTreeNodeType.NodeTypeSuperCategory, "Deleted Categories", 0, 0));

            tempExtendedTreeNode.NodeType = ExtendedTreeNodeType.NodeTypeCategory;
            tempExtendedTreeNode.ImageIndex = 2;
            tempExtendedTreeNode.SelectedImageIndex = 1;
            tempExtendedTreeNode.ContextMenuStrip = cMenuImageCategoryNode;
            tempExtendedTreeNode.Tag = null;
            foreach(ImageCategory category in categories)
            {
                tempExtendedTreeNode.Text = category.categoryName;
                tempExtendedTreeNode.NodeData = category;
                tempExtendedTreeNode.ToolTipText = category.categoryDesc;

                treeImageBrowser.Nodes[0].Nodes.Add((ExtendedTreeNode)tempExtendedTreeNode.Clone());
            }

            ImageListManipulator.ReadAllEntries(ImageListEntryProcessor);
            treeImageBrowser.ExpandAll();

            tempInteger = 0;
            foreach (ExtendedTreeNode node in treeImageBrowser.Nodes[0].Nodes)
            {
                treeImageBrowser.Nodes[0].Nodes[node.Index].Text = node.Text + " (" + node.Nodes.Count.ToString() + ")";
                tempInteger += node.Nodes.Count;
            }

            treeImageBrowser.Nodes[0].Text = "Categorized Images" + " (" + tempInteger.ToString() + ")";
            treeImageBrowser.Nodes[1].Text = "Uncategorized Images" + " (" + treeImageBrowser.Nodes[1].Nodes.Count.ToString() + ")";
            treeImageBrowser.Nodes[2].Text = "Deleted Categories" + " (" + treeImageBrowser.Nodes[2].Nodes.Count.ToString() + ")";

            if (treeImageBrowser.Nodes[2].Nodes.Count > 0 && !asked && AppSettingsManager.NotifyOfImagesInDeletedCategories)
            {
                if (MessageBox.Show(Properties.Resources.promptImagesInDeletedCategory, "Question", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                {
                    foreach (ExtendedTreeNode node in treeImageBrowser.Nodes[1].Nodes)
                    {
                        tempListEntry = new ListEntry();
                        tempListEntry = ImageListManipulator.ReadEntry((UInt32)node.Tag);
                        tempListEntry.imageCategory = "";
                        ImageListManipulator.UpdateEntry(tempListEntry.imageID, tempListEntry);
                    }
                    RefreshImageBrowser();
                }
                asked = true;
            }
        }
        private void treeImageBrowser_AfterSelect(object sender, TreeViewEventArgs e)
        {
            if (virtualFS.GetDbState() != System.Data.ConnectionState.Closed)
            {
                virtualFS.CloseConnection(true);

                ClosePictureBox();

                imageSourceOnline = false;
                txtAddress.Text = "";

                backChain.Clear();
                forwardChain.Clear();
                TreeNonImageNodeActive();
            }

            if (((ExtendedTreeNode)e.Node).NodeType == ExtendedTreeNodeType.NodeTypeImage)
            {
                globalImageListEntry = ((ListEntry)((ExtendedTreeNode)e.Node).NodeData).Clone();
                virtualFS.OpenConnection(AppSettingsManager.ImagesDirectory + "\\" + globalImageListEntry.imageDbPath);
                ShowPictureBox(AppSettingsManager.ImagesDirectory + "\\" + globalImageListEntry.imagePicture);

                ShowRootContents();
                TreeImageNodeActive();

                UpdateBottomPanelImageInfo();
            }
        }
        private void treeImageBrowser_NodeMouseClick(object sender, TreeNodeMouseClickEventArgs e)
        {
            treeImageBrowser.SelectedNode = e.Node;
        }
        private void treeImageBrowser_AfterLabelEdit(object sender, NodeLabelEditEventArgs e)
        {
            VFSEntry tempVFSEntry;
            treeImageBrowser.LabelEdit = false;

            if (e.Label == null)
            {
                e.CancelEdit = true;
                return;
            }
            if (e.Label.Length == 0)
            {
                MessageBox.Show(Properties.Resources.msgImageNameEmpty, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                e.CancelEdit = true;
                return;
            }
            if (e.Label == e.Node.Text)
            {
                e.CancelEdit = true;
                return;
            }

            e.Node.Text = e.Label;
            globalImageListEntry.imageName = e.Label;
            ((ExtendedTreeNode)e.Node).NodeData = globalImageListEntry.Clone();
            ImageListManipulator.UpdateEntry(globalImageListEntry.imageID, globalImageListEntry);

            tempVFSEntry = virtualFS.ReadEntry(0);
            tempVFSEntry.name = e.Label;
            virtualFS.UpdateEntry(0, tempVFSEntry);

            //treeImageBrowser.AfterSelect -= treeImageBrowser_AfterSelect;
            //treeImageBrowser.SelectedNode = treeImageBrowser.Nodes.Find(globalImageListEntry.imageID.ToString(), true)[0];
            //treeImageBrowser.AfterSelect += treeImageBrowser_AfterSelect;
            subMenuItemRefreshlViewVFSBrowser_Click(new object(), EventArgs.Empty);
        }
        private void TreeImageNodeActive()
        {
            menuItemSynchronize.Enabled = true;
            menuItemShowProp.Enabled = true;
            menuItemDelImage.Enabled = true;

            subMenuItemRefreshlViewVFSBrowser.Enabled = true;
            toolBtnlViewBrowserRefresh.Enabled = true;

            subMenuViewlViewVFSBrowser.Enabled = true;
            toolMenulViewVFSBrowserView.Enabled = true;

            subMenuArrangeIcons.Enabled = true;
            toolMenuArrangeIconsBy.Enabled = true;

            subMenuArrangeIcons.Enabled = true;
        }
        private void TreeNonImageNodeActive()
        {
            menuItemSynchronize.Enabled = false;
            menuItemShowProp.Enabled = false;
            menuItemDelImage.Enabled = false;

            if (AppSettingsManager.ShowExtendedPropertiesPanel)
                ClearExtendedPropertiesPanel();
            
            lViewVFSBrowser.LargeImageList.Images.Clear();
            lViewVFSBrowser.SmallImageList.Images.Clear();
            statusStripLblImageIcon.Image = null;
            statusStripLblImageInfo.Text = "";
            statusStripLblVFSItemIcon.Image = null;
            statusStripLblVFSItemInfo.Text = "";
            imageSourceOnline = false;

            VFSInActive();
        }

        #endregion

        #region lViewVFSBrowser handling code

        private void ShowRootContents()
        {
            lViewVFSBrowser.BeginUpdate();

            ClearContents();
            totalInvisibleObjects = 0;
            virtualFS.ReadSubEntries(0, VFSEntryProcessor);
            currentLocationID = 0;

            lViewVFSBrowser.AutoResizeColumns(ColumnHeaderAutoResizeStyle.HeaderSize);
            lViewVFSBrowser.EndUpdate();

            subMenuItemlViewVFSBrowserGoUp.Enabled = false;
            toolBtnlViewVFSBrowserGoUp.Enabled = false;

            subMenuItemlViewVFSBrowserGoToRoot.Enabled = false;
            toolBtnlViewVFSBrowserGoToRoot.Enabled = false;

            subMenuItemVFSItemProperties.Enabled = false;
            toolBtnVFSItemProperties.Enabled = false;

            txtAddress.Text = globalImageListEntry.imageName + "\\";

            UpdateBottomPanelVFSBrowserInfo(null);
            if (AppSettingsManager.ShowExtendedPropertiesPanel)
                ClearExtendedPropertiesPanel();
        }
        private void ShowContents(UInt32 entryNumber)
        {
            if (entryNumber == 0)
            {
                ShowRootContents();
                return;
            }

            lViewVFSBrowser.BeginUpdate();

            ClearContents();
            totalInvisibleObjects = 0;
            virtualFS.ReadSubEntries(entryNumber, VFSEntryProcessor);
            currentLocationID = entryNumber;

            lViewVFSBrowser.AutoResizeColumns(ColumnHeaderAutoResizeStyle.HeaderSize);
            lViewVFSBrowser.EndUpdate();

            subMenuItemlViewVFSBrowserGoUp.Enabled = true;
            toolBtnlViewVFSBrowserGoUp.Enabled = true;

            subMenuItemlViewVFSBrowserGoToRoot.Enabled = true;
            toolBtnlViewVFSBrowserGoToRoot.Enabled = true;

            subMenuItemVFSItemProperties.Enabled = false;
            toolBtnVFSItemProperties.Enabled = false;

            txtAddress.Text = virtualFS.GetPathFromList(virtualFS.TracePathToEntry(currentLocationID));

            UpdateBottomPanelVFSBrowserInfo(null);
            if (AppSettingsManager.ShowExtendedPropertiesPanel)
                ClearExtendedPropertiesPanel();
        }
        private void UpdateBottomPanelVFSBrowserInfo(ListViewItemSelectionChangedEventArgs e)
        {
            FileTypeInfo typeInfo;
            VFSEntry vfsEntry;
            string temp = "";

            if (lViewVFSBrowser.SelectedItems.Count == 0)
            {
                selectionSize = 0;
                vfsEntry = virtualFS.ReadEntry(currentLocationID);
                statusStripLblVFSItemIcon.Image = fTypeManager.GetIconForType("*dir", IconSize.IconLarge).ToBitmap();

                if (vfsEntry.name.Length > 50)
                    statusStripLblVFSItemInfo.Text = vfsEntry.name.Substring(0, 47) + "...";
                else
                    statusStripLblVFSItemInfo.Text = vfsEntry.name;
                if (currentLocationID == 0)
                {
                    statusStripLblVFSItemInfo.Text += Environment.NewLine + "Type: Image Root Folder";
                    statusStripLblVFSItemInfo.Text += Environment.NewLine + "Image Database Filename: " + globalImageListEntry.imageDbPath;
                }
                else
                {
                    statusStripLblVFSItemInfo.Text += Environment.NewLine + "Type: File Folder";
                    if (vfsEntry.isROnly)
                        temp = Environment.NewLine + "Attributes: Read Only";
                    if (vfsEntry.isHidden)
                        temp += (temp.Length > 0) ? ", Hidden" : Environment.NewLine + "Attributes: Hidden";
                    if (vfsEntry.isArch)
                        temp += (temp.Length > 0) ? ", Archive" : Environment.NewLine + "Attributes: Archive";
                    if (vfsEntry.isSystem)
                        temp += (temp.Length > 0) ? ", System" : Environment.NewLine + "Attributes: System";
                    if (vfsEntry.isCompressed)
                        temp += (temp.Length > 0) ? ", Compressed" : Environment.NewLine + "Attributes: Compressed";
                    if (vfsEntry.isEncrypted)
                        temp += (temp.Length > 0) ? ", Encrypted" : Environment.NewLine + "Attributes: Encrypted";
                    statusStripLblVFSItemInfo.Text += temp;
                }
                statusStripLblVFSItemInfo.Text += Environment.NewLine;
                statusStripLblVFSItemInfo.Text += lViewVFSBrowser.Items.Count.ToString() + " objects";
                if (AppSettingsManager.NotifyOfInvisibleObjects)
                    statusStripLblVFSItemInfo.Text += " shown, " + totalInvisibleObjects.ToString() + " invisible";
            }
            else if (lViewVFSBrowser.SelectedItems.Count == 1)
            {
                vfsEntry = ((ExtendedListViewItem)lViewVFSBrowser.SelectedItems[0]).ItemVFSEntry;
                selectionSize = vfsEntry.size;
                if (!vfsEntry.isDir)
                {
                    typeInfo = fTypeManager.GetFileTypeInfo(Path.GetExtension(vfsEntry.name));
                    if (typeInfo == null)
                        typeInfo = fTypeManager.GetFileTypeInfo("*file");
                }
                else
                    typeInfo = fTypeManager.GetFileTypeInfo("*dir");

                statusStripLblVFSItemIcon.Image = lViewVFSBrowser.LargeImageList.Images[lViewVFSBrowser.SelectedItems[0].ImageKey];
                statusStripLblVFSItemInfo.Text = vfsEntry.name;
                statusStripLblVFSItemInfo.Text += Environment.NewLine + "Type: " + typeInfo.typeName;
                if (vfsEntry.size > 0)
                    statusStripLblVFSItemInfo.Text += Environment.NewLine + "Size: " + GeneralMethods.GetFormattedSize(vfsEntry.size);
                if (vfsEntry.isROnly)
                    temp = Environment.NewLine + "Attributes: Read Only";
                if (vfsEntry.isHidden)
                    temp += ((temp.Length > 0) ? ", Hidden" : Environment.NewLine + "Attributes: Hidden");
                if (vfsEntry.isArch)
                    temp += ((temp.Length > 0) ? ", Archive" : Environment.NewLine + "Attributes: Archive");
                if (vfsEntry.isSystem)
                    temp += ((temp.Length > 0) ? ", System" : Environment.NewLine + "Attributes: System");
                if (vfsEntry.isCompressed)
                    temp += ((temp.Length > 0) ? ", Compressed" : Environment.NewLine + "Attributes: Compressed");
                if (vfsEntry.isEncrypted)
                    temp += ((temp.Length > 0) ? ", Encrypted" : Environment.NewLine + "Attributes: Encrypted");
                statusStripLblVFSItemInfo.Text += temp;
            }
            else
            {
                vfsEntry = ((ExtendedListViewItem)e.Item).ItemVFSEntry;
                statusStripLblVFSItemInfo.Text = lViewVFSBrowser.SelectedItems.Count.ToString() + " items selected.";
                if (e.IsSelected)
                    selectionSize += vfsEntry.size;
                else
                    selectionSize -= vfsEntry.size;
                if (selectionSize > 0)
                {
                    statusStripLblVFSItemInfo.Text += Environment.NewLine;
                    statusStripLblVFSItemInfo.Text += "Size: " + GeneralMethods.GetFormattedSize(selectionSize);
                }
            }
        }
        private void UpdateExtendedPropertiesPanel(ListViewItemSelectionChangedEventArgs e)
        {
            VFSEntry entry;

            if (!e.IsSelected || lViewVFSBrowser.SelectedItems.Count > 1)
            {
                ClearExtendedPropertiesPanel();
                return;
            }

            entry = ((ExtendedListViewItem)e.Item).ItemVFSEntry;
            lblExtendedProperties.Text = GeneralMethods.FormatMusicInfo(entry);

            if (imageSourceOnline && !entry.isDir)
            {
                string fullPath = globalImageListEntry.imageSourcePath;

                fullPath += (fullPath.EndsWith("\\") ? "" : "\\");
                fullPath += (txtAddress.Text.Substring(txtAddress.Text.IndexOf("\\") + 1)) + entry.name;

                multiPreviewer.Preview(fullPath, false);
            }
        }
        private void ClearExtendedPropertiesPanel()
        {
            if (txtAddress.Text.Length > 0)
            {
                lblExtendedProperties.Text = "Select an object to view its properties.";
                if (imageSourceOnline)
                    multiPreviewer.Preview("Select a file to preview.", true);
                else
                    multiPreviewer.Preview("  ", true);
            }
            else
            {
                lblExtendedProperties.Text = "No image selected.";
                multiPreviewer.Preview("No image selected.", true);
            }
        }
        private void ClearContents()
        {
            lViewVFSBrowser.Items.Clear();
        }
        private void VFSInActive()
        {
            ClearContents();
            backChain.Clear();
            forwardChain.Clear();

            subMenuItemRefreshlViewVFSBrowser.Enabled = false;
            toolBtnlViewBrowserRefresh.Enabled = false;

            subMenuItemVFSItemProperties.Enabled = false;
            toolBtnVFSItemProperties.Enabled = false;

            subMenuViewlViewVFSBrowser.Enabled = false;
            toolMenulViewVFSBrowserView.Enabled = false;

            subMenuArrangeIcons.Enabled = false;
            toolMenuArrangeIconsBy.Enabled = false;

            subMenuItemlViewVFSBrowserGoBack.Enabled = false;
            toolBtnlViewVFSBrowserGoBack.Enabled = false;

            subMenuItemlViewVFSBrowserGoForward.Enabled = false;
            toolBtnlViewVFSBrowserGoForward.Enabled = false;

            subMenuItemlViewVFSBrowserGoUp.Enabled = false;
            toolBtnlViewVFSBrowserGoUp.Enabled = false;

            subMenuItemlViewVFSBrowserGoToRoot.Enabled = false;
            toolBtnlViewVFSBrowserGoToRoot.Enabled = false;
        }      
        private void lViewVFSBrowser_ItemActivate(object sender, EventArgs e)
        {
            VFSEntry tempVFSEntry;
            string fullPath="";

            if (lViewVFSBrowser.SelectedItems.Count != 1)
                return;

            tempVFSEntry = ((ExtendedListViewItem)lViewVFSBrowser.SelectedItems[0]).ItemVFSEntry;

            if (tempVFSEntry.isDir)
            {
                backChain.Push(currentLocationID);
                forwardChain.Clear();
                ShowContents(tempVFSEntry.entryNo);

                subMenuItemlViewVFSBrowserGoBack.Enabled = true;
                toolBtnlViewVFSBrowserGoBack.Enabled = true;

                subMenuItemlViewVFSBrowserGoForward.Enabled = false;
                toolBtnlViewVFSBrowserGoForward.Enabled = false;
            }
            else
            {
                if (imageSourceOnline)
                {
                    fullPath = globalImageListEntry.imageSourcePath;
                    if (!fullPath.EndsWith("\\"))
                        fullPath += "\\";
                    fullPath += txtAddress.Text.Substring(txtAddress.Text.IndexOf("\\")+1);
                    fullPath += tempVFSEntry.name;
                    try
                    {
                        if (!File.Exists(fullPath))
                        {
                            MessageBox.Show("The file " + fullPath + " was not found.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }
                        ProcessStartInfo a = new ProcessStartInfo(fullPath);
                        a.UseShellExecute = true;
                        a.WorkingDirectory = Path.GetDirectoryName(fullPath);
                        Process.Start(a);
                    }
                    catch(Win32Exception ex)
                    {
                        MessageBox.Show("There was an error starting " + fullPath + ". The error message follows:\r\n"
                            + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }
                }
                else
                {
                    MessageBox.Show(Properties.Resources.msgImageSourceOffline, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }
            }
        }
        private void lViewVFSBrowser_ItemSelectionChanged(object sender, ListViewItemSelectionChangedEventArgs e)
        {
            if (lViewVFSBrowser.SelectedItems.Count < 1)
            {
                subMenuItemVFSItemProperties.Enabled = false;
                toolBtnVFSItemProperties.Enabled = false;
            }
            else
            {
                subMenuItemVFSItemProperties.Enabled = true;
                toolBtnVFSItemProperties.Enabled = true;
            }
            if (AppSettingsManager.ShowObjectDetailsOnBottomPanel)
                UpdateBottomPanelVFSBrowserInfo(e);
            if (AppSettingsManager.ShowExtendedPropertiesPanel)
                UpdateExtendedPropertiesPanel(e);
        }
        private void lViewVFSBrowser_MouseClick(object sender, MouseEventArgs e)
        {
            //if (e.Button == MouseButtons.Right && txtAddress.Text.Length > 0)
            //{
            //    if (lViewVFSBrowser.SelectedItems.Count > 0)
            //        cMenuVFSItem.Show(lViewVFSBrowser, e.Location);
            //    else
            //        cMenuVFSBrowser.Show(lViewVFSBrowser, e.Location);
            //}
        }
        private void AddDetailColumns()
        {
            lViewVFSBrowser.Columns.Add("name", "Name");
            if (AppSettingsManager.ShowSizeColumn) lViewVFSBrowser.Columns.Add("size", "File Size");
            if (AppSettingsManager.ShowItemTypeColumn) lViewVFSBrowser.Columns.Add("iType", "Type");
            if (AppSettingsManager.ShowModifiedDateColumn) lViewVFSBrowser.Columns.Add("modified", "Date Modified");
            if (AppSettingsManager.ShowCreatedDateColumn) lViewVFSBrowser.Columns.Add("created", "Date Created");
            if (AppSettingsManager.ShowAccessedDateColumn) lViewVFSBrowser.Columns.Add("accessed", "Date Accessed");
            if (AppSettingsManager.ShowAttributesColumn) lViewVFSBrowser.Columns.Add("attributes", "Attrubutes");

            if (AppSettingsManager.ShowOwnerColumn) lViewVFSBrowser.Columns.Add("owner", "Owner");
            if (AppSettingsManager.ShowAuthorColumn) lViewVFSBrowser.Columns.Add("author", "Author");
            if (AppSettingsManager.ShowTitleColumn) lViewVFSBrowser.Columns.Add("title", "Title");
            if (AppSettingsManager.ShowSubjectColumn) lViewVFSBrowser.Columns.Add("subject", "Subject");
            if (AppSettingsManager.ShowCategoryColumn) lViewVFSBrowser.Columns.Add("category", "Category");
            if (AppSettingsManager.ShowPagesColumn) lViewVFSBrowser.Columns.Add("pages", "Pages");
            if (AppSettingsManager.ShowCommentsColumn) lViewVFSBrowser.Columns.Add("comments", "Comments");

            if (AppSettingsManager.ShowArtistColumn) lViewVFSBrowser.Columns.Add("artist", "Artist");
            if (AppSettingsManager.ShowAlbumColumn) lViewVFSBrowser.Columns.Add("album", "Album");
            if (AppSettingsManager.ShowAlbumYearColumn) lViewVFSBrowser.Columns.Add("albumYear", "Album Year");
            if (AppSettingsManager.ShowTrackNoColumn) lViewVFSBrowser.Columns.Add("trackNo", "Track Number");
            if (AppSettingsManager.ShowDurationColumn) lViewVFSBrowser.Columns.Add("trackDuration", "Duration");
            if (AppSettingsManager.ShowGenreColumn) lViewVFSBrowser.Columns.Add("genre", "Genre");

            if (AppSettingsManager.ShowBitrateColumn) lViewVFSBrowser.Columns.Add("bitRate", "Bitrate");
            if (AppSettingsManager.ShowSampleRateColumn) lViewVFSBrowser.Columns.Add("sampleRate", "Sample Rate");
            if (AppSettingsManager.ShowFrameRateColumn) lViewVFSBrowser.Columns.Add("frameRate", "Frame Rate");
            if (AppSettingsManager.ShowDimensionsColumn) lViewVFSBrowser.Columns.Add("dimenstions", "Dimensions");

            if (AppSettingsManager.ShowCompanyColumn) lViewVFSBrowser.Columns.Add("company", "Company");
            if (AppSettingsManager.ShowDescriptionColumn) lViewVFSBrowser.Columns.Add("description", "Description");
            if (AppSettingsManager.ShowVersionColumn) lViewVFSBrowser.Columns.Add("version", "File Version");
            if (AppSettingsManager.ShowProductNameColumn) lViewVFSBrowser.Columns.Add("pName", "Product Name");
            if (AppSettingsManager.ShowPVersionColumn) lViewVFSBrowser.Columns.Add("pVersion", "Product Version");
            if (AppSettingsManager.ShowCopyrightColumn) lViewVFSBrowser.Columns.Add("copyright", "Copyright");
        }

        #endregion

        #region Menus and toolbar handling code

        #region Event Handlers for Menu Items

        private void menuItemNewImage_Click(object sender, EventArgs e)
        {
            WndNewImage newImageWindow = new WndNewImage();

            newImageWindow.ShowDialog(categories);
            if (newImageWindow.Reload)
            {
                categories = CategoryManager.GetAllCategories();
                RefreshImageBrowser();
            }
            newImageWindow.Dispose();
        }
        private void menuItemDelImage_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show(Properties.Resources.promptImageDelete, "Question", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                return;

            if (virtualFS.GetDbState() == System.Data.ConnectionState.Open)
            {
                ClearContents();
                ClosePictureBox();
                virtualFS.CloseConnection(true);
            }

            if (File.Exists(AppSettingsManager.ImagesDirectory + "\\" + globalImageListEntry.imageDbPath))
                File.Delete(AppSettingsManager.ImagesDirectory + "\\" + globalImageListEntry.imageDbPath);

            if (File.Exists(AppSettingsManager.ImagesDirectory + "\\" + globalImageListEntry.imagePicture))
                File.Delete(AppSettingsManager.ImagesDirectory + "\\" + globalImageListEntry.imagePicture);

            ImageListManipulator.DeleteEntry(globalImageListEntry.imageID);
            
            txtAddress.Text = "";
            RefreshImageBrowser();
            TreeNonImageNodeActive();
        }
        private void menuItemShowImageProp_Click(object sender, EventArgs e)
        {
            VFSEntry tempVFSEntry = new VFSEntry();
            ImageProperties ip = new ImageProperties();
            ListEntry tempListEntry;

            ip.imageEntry = globalImageListEntry.Clone();
            ip.imageCategories = categories;
            ip.totalDirs = (UInt32)(virtualFS.GetTotalEntries("IsDirectory=True") - 1);
            ip.totalFiles = (UInt32)virtualFS.GetTotalEntries("IsDirectory=False");
            WndImageProperties imgPropWindow = new WndImageProperties(ip);

            tempListEntry = imgPropWindow.ShowDialog();

            if (imgPropWindow.DialogResult == DialogResult.OK)
            {
                if (!ip.imageEntry.Equals(globalImageListEntry))
                {
                    if (ip.imageEntry.imagePicture != globalImageListEntry.imagePicture)
                    {
                        if (globalImageListEntry.imagePicture != null && globalImageListEntry.imagePicture != "")
                        {
                            ClosePictureBox();
                            File.SetAttributes(AppSettingsManager.ImagesDirectory + "\\" + globalImageListEntry.imagePicture, FileAttributes.Archive);
                            File.Delete(AppSettingsManager.ImagesDirectory + "\\" + globalImageListEntry.imagePicture);
                        }
                        if (ip.imageEntry.imagePicture != null && ip.imageEntry.imagePicture != "")
                        {
                            string temp = ip.imageEntry.imageDbPath + Path.GetExtension(ip.imageEntry.imagePicture);
                            File.Copy(ip.imageEntry.imagePicture, AppSettingsManager.ImagesDirectory + "\\" + temp);
                            ShowPictureBox(AppSettingsManager.ImagesDirectory + "\\" + temp);
                            ip.imageEntry.imagePicture = temp;
                        }
                    }

                    ImageListManipulator.UpdateEntry(ip.imageEntry.imageID, ip.imageEntry);
                    if (ip.imageEntry.imageName != globalImageListEntry.imageName)
                    {
                        tempVFSEntry = virtualFS.ReadEntry(0);
                        tempVFSEntry.name = ip.imageEntry.imageName;
                        virtualFS.UpdateEntry(0, tempVFSEntry);
                    }

                    globalImageListEntry = ip.imageEntry.Clone();
                    RefreshImageBrowser();
                    treeImageBrowser.AfterSelect -= treeImageBrowser_AfterSelect;
                    treeImageBrowser.SelectedNode = treeImageBrowser.Nodes.Find(globalImageListEntry.imageID.ToString(), true)[0];
                    treeImageBrowser.AfterSelect += treeImageBrowser_AfterSelect;
                    subMenuItemRefreshlViewVFSBrowser_Click(new object(), EventArgs.Empty);
                    UpdateBottomPanelImageInfo();
                }
            }
            imgPropWindow.Dispose();
        }
        private void subMenuItemVFSItemProperties_Click(object sender, EventArgs e)
        {
            VFSEntry tempVFSEntry;
            FileTypeInfo tempFileTypeInfo;

            if (lViewVFSBrowser.SelectedItems.Count > 1)
            {
                WndVFSMultipleItemsProperties wndVFSMultipleItemsProp = new WndVFSMultipleItemsProperties(virtualFS, lViewVFSBrowser.SelectedItems, txtAddress.Text);

                wndVFSMultipleItemsProp.ShowDialog();
                wndVFSMultipleItemsProp.Dispose();
            }
            else
            {
                tempVFSEntry = ((ExtendedListViewItem)lViewVFSBrowser.SelectedItems[0]).ItemVFSEntry;
                if (tempVFSEntry.isDir)
                {
                    WndVFSFolderProperties wndVFSFolderProp = new WndVFSFolderProperties(fTypeManager.GetFileTypeInfo("*dir"), virtualFS, tempVFSEntry);

                    wndVFSFolderProp.ShowDialog();
                    wndVFSFolderProp.Dispose();
                }
                else
                {
                    tempFileTypeInfo = fTypeManager.GetFileTypeInfo(Path.GetExtension(tempVFSEntry.name));
                    if (tempFileTypeInfo == null)
                        tempFileTypeInfo = fTypeManager.GetFileTypeInfo("*file");
                    if (tempVFSEntry.fileIcon != null)
                        tempFileTypeInfo.largeIcon = IconFunctions.IconFromBytes(tempVFSEntry.fileIcon);
                    else if (tempFileTypeInfo.largeIcon == null)
                        tempFileTypeInfo.largeIcon = fTypeManager.GetIconForType("*file", IconSize.IconLarge);

                    WndVFSFileProperties wndVFSFileProp = new WndVFSFileProperties(tempVFSEntry, tempFileTypeInfo, txtAddress.Text);

                    wndVFSFileProp.ShowDialog();
                    wndVFSFileProp.Dispose();
                }
            }
        }
        private void subMenuItemRefreshlViewVFSBrowser_Click(object sender, EventArgs e)
        {
            ClearContents();
            ShowContents(currentLocationID);
            UpdateBottomPanelImageInfo();

            subMenuItemVFSItemProperties.Enabled = false;
            toolBtnVFSItemProperties.Enabled = false;
        }
        private void subMenuItemViewIcons_Click(object sender, EventArgs e)
        {
            if (lViewVFSBrowser.View != View.LargeIcon)
            {
                lViewVFSBrowser.Columns.Clear();
                lViewVFSBrowser.View = View.LargeIcon;
            }
        }
        private void subMenuItemViewList_Click(object sender, EventArgs e)
        {
            if (lViewVFSBrowser.View != View.List)
            {
                lViewVFSBrowser.Columns.Clear();
                lViewVFSBrowser.View = View.List;
            }
        }
        private void subMenuItemViewDetails_Click(object sender, EventArgs e)
        {
            if (lViewVFSBrowser.View != View.Details)
            {
                lViewVFSBrowser.View = View.Details;
                if (txtAddress.Text.Length > 0)
                    subMenuItemRefreshlViewVFSBrowser_Click(sender, e);
            }
        }
        private void subMenuItemlViewVFSBrowserGoUp_Click(object sender, EventArgs e)
        {
            backChain.Push(currentLocationID);
            forwardChain.Clear();

            ShowContents((uint)virtualFS.ReadEntry(currentLocationID).parentDir);

            subMenuItemlViewVFSBrowserGoForward.Enabled = false;
            toolBtnlViewVFSBrowserGoForward.Enabled = false;
        }
        private void subMenuItemlViewVFSBrowserGoToRoot_Click(object sender, EventArgs e)
        {
            backChain.Push(currentLocationID);
            forwardChain.Clear();
            ShowRootContents();

            subMenuItemlViewVFSBrowserGoForward.Enabled = false;
            toolBtnlViewVFSBrowserGoForward.Enabled = false;
        }
        private void subMenuItemlViewVFSBrowserGoBack_Click(object sender, EventArgs e)
        {
            forwardChain.Push(currentLocationID);
            ShowContents(backChain.Pop());

            subMenuItemlViewVFSBrowserGoForward.Enabled = true;
            toolBtnlViewVFSBrowserGoForward.Enabled = true;

            if (backChain.Count < 1)
            {
                subMenuItemlViewVFSBrowserGoBack.Enabled = false;
                toolBtnlViewVFSBrowserGoBack.Enabled = false;
            }
        }
        private void subMenuItemlViewVFSBrowserGoForward_Click(object sender, EventArgs e)
        {
            backChain.Push(currentLocationID);
            ShowContents(forwardChain.Pop());

            subMenuItemlViewVFSBrowserGoBack.Enabled = true;
            toolBtnlViewVFSBrowserGoBack.Enabled = true;

            if (forwardChain.Count < 1)
            {
                subMenuItemlViewVFSBrowserGoForward.Enabled = false;
                toolBtnlViewVFSBrowserGoForward.Enabled = false;
            }
        }
        private void menuItemAboutCDSync_Click(object sender, EventArgs e)
        {
            MessageBox.Show("Developed by Ankit Rajpoot.\r\nApplication version: " + Application.ProductVersion.ToString());
        }
        private void menuItemCategories_Click(object sender, EventArgs e)
        {
            WndImageCategoryManager wndCategoryManager = new WndImageCategoryManager();

            wndCategoryManager.ShowDialog();

            if (wndCategoryManager.Reload)
            {
                categories = CategoryManager.GetAllCategories();
                RefreshImageBrowser();
                if (txtAddress.Text.Length > 0)
                {
                    treeImageBrowser.AfterSelect -= treeImageBrowser_AfterSelect;
                    treeImageBrowser.SelectedNode = treeImageBrowser.Nodes.Find(globalImageListEntry.imageID.ToString(), true)[0];
                    treeImageBrowser.AfterSelect += treeImageBrowser_AfterSelect;
                }
            }
            wndCategoryManager.Dispose();
        }
        private void menuItemOptions_Click(object sender, EventArgs e)
        {
            WndApplicationOptions wndOptions = new WndApplicationOptions();

            if (wndOptions.ShowDialog() == DialogResult.OK)
            {
                lViewVFSBrowser.BeginUpdate();
                lViewVFSBrowser.Columns.Clear();
                AddDetailColumns();
                lViewVFSBrowser.EndUpdate();
                if (txtAddress.Text.Length > 0)
                    subMenuItemRefreshlViewVFSBrowser_Click(sender, e);
                if (!AppSettingsManager.ShowExtendedPropertiesPanel)
                {
                    ClearExtendedPropertiesPanel();
                    viewSplitter3.Panel2Collapsed = true;
                }
                else
                    viewSplitter3.Panel2Collapsed = false;
            }
        }
        private void menuItemExportImages_Click(object sender, EventArgs e)
        {
            WndExportImages wndExportImages = new WndExportImages();
            wndExportImages.ShowDialog(new List<uint>());
        }
        private void menuItemImportImages_Click(object sender, EventArgs e)
        {
            WndImportImages wndImport = new WndImportImages();

            // Reflect the changes if any, in the main window.
            if (wndImport.ShowDialog() == DialogResult.OK)
            {
                categories = CategoryManager.GetAllCategories();
                RefreshImageBrowser();
            }
        }

        #endregion

        #region Toolbar handler code
        
        private void toolBarMenuItemViewIcons_Click(object sender, EventArgs e)
        {
            subMenuItemViewIcons_Click(sender, e);
        }
        private void toolBarMenuItemViewList_Click(object sender, EventArgs e)
        {
            subMenuItemViewList_Click(sender, e);
        }
        private void toolBarMenuItemViewDetails_Click(object sender, EventArgs e)
        {
            subMenuItemViewDetails_Click(sender, e);
        }
        private void toolBtnlViewVFSBrowserGoBack_Click(object sender, EventArgs e)
        {
            subMenuItemlViewVFSBrowserGoBack_Click(sender, e);
        }
        private void toolBtnlViewVFSBrowserGoForward_Click(object sender, EventArgs e)
        {
            subMenuItemlViewVFSBrowserGoForward_Click(sender, e);
        }
        private void toolBtnlViewVFSBrowserGoUp_Click(object sender, EventArgs e)
        {
            subMenuItemlViewVFSBrowserGoUp_Click(sender, e);
        }
        private void toolBtnlViewVFSBrowserGoToRoot_Click(object sender, EventArgs e)
        {
            subMenuItemlViewVFSBrowserGoToRoot_Click(sender, e);
        }
        private void toolBtnVFSItemProperties_Click(object sender, EventArgs e)
        {
            subMenuItemVFSItemProperties_Click(sender, e);
        }
        private void toolBtnlViewBrowserRefresh_Click(object sender, EventArgs e)
        {
            subMenuItemRefreshlViewVFSBrowser_Click(sender, e);
        }
        private void toolBtnVFSItemSearch_CheckChanged(object sender, EventArgs e)
        {
            if (!viewSplitter.Panel1Collapsed)
            {
                while (viewSplitter.SplitterDistance > viewSplitter.Panel1MinSize)
                    viewSplitter.SplitterDistance -= 15;
                viewSplitter.Panel1Collapsed = true;
            }
            else
            {
                viewSplitter.Panel1Collapsed = false;
                while (viewSplitter.SplitterDistance < 200)
                    viewSplitter.SplitterDistance += 20;
            }
        }
        private void toolBtnOptions_Click(object sender, EventArgs e)
        {
            menuItemOptions_Click(sender, e);
        }

        #endregion
                
        #region Context menu handlers
        
        private void cMenuVFSItemProperties_Click(object sender, EventArgs e)
        {
            subMenuItemVFSItemProperties_Click(sender, e);
        }
        private void cMenuItemRenImage_Click(object sender, EventArgs e)
        {
            treeImageBrowser.LabelEdit = true;
            treeImageBrowser.SelectedNode.BeginEdit();
        }
        private void cMenuImageCNodeItemEditCategory_Click(object sender, EventArgs e)
        {
            ImageCategory tempImageCategory1, tempImageCategory2;
            WndEditImageCategory wndEditImageCategory;
            ListEntry tempListEntry;

            tempImageCategory1 = (ImageCategory)((ExtendedTreeNode)treeImageBrowser.SelectedNode).NodeData;
            wndEditImageCategory = new WndEditImageCategory("Modify Image Category", tempImageCategory1);

            tempImageCategory2 = wndEditImageCategory.ShowDialog();

            if (wndEditImageCategory.DialogResult == DialogResult.OK)
            {
                CategoryManager.RemoveCategory(tempImageCategory1);
                CategoryManager.AddCategory(tempImageCategory2);
                categories = CategoryManager.GetAllCategories();

                if (tempImageCategory1.categoryName != tempImageCategory2.categoryName)
                {
                    foreach (ExtendedTreeNode node in treeImageBrowser.SelectedNode.Nodes)
                    {
                        tempListEntry = (ListEntry)node.NodeData;
                        tempListEntry.imageCategory = tempImageCategory2.categoryName;

                        ImageListManipulator.UpdateEntry(tempListEntry.imageID, tempListEntry);
                    }
                }

                RefreshImageBrowser();
                //if (txtAddress.Text.Length > 0)
                //{
                //    treeImageBrowser.AfterSelect -= treeImageBrowser_AfterSelect;
                //    treeImageBrowser.SelectedNode = treeImageBrowser.Nodes.Find(globalImageListEntry.imageID.ToString(), true)[0];
                //    treeImageBrowser.AfterSelect += treeImageBrowser_AfterSelect;
                //}
            }
            wndEditImageCategory.Dispose();
        }
        private void cMenuImageCNodeItemRemoveCategory_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show(Resources.promptImageCategoryDelete, "Question?", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
            {
                CategoryManager.RemoveCategory((ImageCategory)((ExtendedTreeNode)treeImageBrowser.SelectedNode).NodeData);
                categories = CategoryManager.GetAllCategories();
                RefreshImageBrowser();
            }
        }
        private void cMenuImageCNodeItemRemoveImages_Click(object sender, EventArgs e)
        {
            ListEntry tempListEntry;
            if (MessageBox.Show(Resources.promptMemberImagesDelete, "Question?", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
            {
                foreach (ExtendedTreeNode node in treeImageBrowser.SelectedNode.Nodes)
                {
                    tempListEntry = (ListEntry)node.NodeData;

                    if (File.Exists("dbs\\" + tempListEntry.imageDbPath))
                        File.Delete("dbs\\" + tempListEntry.imageDbPath);

                    if (File.Exists("dbs\\" + tempListEntry.imagePicture))
                        File.Delete("dbs\\" + tempListEntry.imagePicture);

                    ImageListManipulator.DeleteEntry(tempListEntry.imageID);
                }
                RefreshImageBrowser();
            }
        }
        private void cMenuImageNodeItemExportImage_Click(object sender, EventArgs e)
        {
            MessageBox.Show("cMenuImageNodeItemExportImage_Click called");
        }
        private void cMenuImageNodeItemExportList_Click(object sender, EventArgs e)
        {

        }
        private void cMenuImageNodeItemExportTree_Click(object sender, EventArgs e)
        {

        }
        private void cMenuVFSBrowserItemIcons_Click(object sender, EventArgs e)
        {
            subMenuItemViewIcons_Click(sender, e);
        }
        private void cMenuVFSBrowserItemList_Click(object sender, EventArgs e)
        {
            subMenuItemViewList_Click(sender, e);
        }
        private void cMenuVFSBrowserItemDetails_Click(object sender, EventArgs e)
        {
            subMenuItemViewDetails_Click(sender, e);
        }
        private void cMenuImageCNodeItemExportImages_Click(object sender, EventArgs e)
        {
            List<UInt32> memberImages = new List<uint>();
            foreach (ExtendedTreeNode node in treeImageBrowser.SelectedNode.Nodes)
                memberImages.Add(((ListEntry)node.NodeData).imageID);

            if (memberImages.Count > 0)
            {
                WndExportImages wndExportImages = new WndExportImages();
                wndExportImages.ShowDialog(memberImages);
            }
        }
        private void cMenuVFSBrowserItemRefresh_Click(object sender, EventArgs e)
        {
            subMenuItemRefreshlViewVFSBrowser_Click(sender, e);
        }
        private void cMenuVFSBrowserItemProperties_Click(object sender, EventArgs e)
        {
            if (currentLocationID == 0)
                menuItemShowImageProp_Click(sender, e);
            else
            {
                WndVFSFolderProperties wnd = new WndVFSFolderProperties(fTypeManager.GetFileTypeInfo("*dir"),
                                                    virtualFS, virtualFS.ReadEntry(currentLocationID));
                wnd.ShowDialog();
            }
        }
        
        #endregion

        #endregion

        #region Miscellaneous Code

        private void VFSEntryProcessor(VFSEntry entry)
        {
            string imageKey, tempString;
            Icon iconL, iconS;
            ExtendedListViewItem tempExtendedListViewItem = new ExtendedListViewItem(ExtendedListViewItemType.ListViewItemTypeVFSItem);

            if ((AppSettingsManager.HideArchive && entry.isArch) ||
                (AppSettingsManager.HideReadOnly && entry.isROnly) ||
                (AppSettingsManager.HideHidden && entry.isHidden) ||
                (AppSettingsManager.HideSystem && entry.isSystem) ||
                (AppSettingsManager.HideCompressed && entry.isCompressed) ||
                (AppSettingsManager.HideEncrypted && entry.isEncrypted))
            {
                totalInvisibleObjects++;
                return;
            }

            tempExtendedListViewItem.ItemVFSEntry = entry;
            if (entry.isEncrypted || entry.isCompressed)
                tempExtendedListViewItem.ForeColor = AppSettingsManager.SpecialIconTextColor;

            imageKey = Path.GetExtension(entry.name);
            if (entry.isDir)
                imageKey = "*dir";
            else if (entry.fileIcon == null)
                imageKey = (imageKey == null || imageKey == String.Empty) ? "*file" : imageKey;
            else
                imageKey = "*" + entry.entryNo.ToString();

            tempString = imageKey;
            if (entry.fileIcon == null)
            {
                iconL = fTypeManager.GetIconForType(imageKey, IconSize.IconLarge);
                iconS = fTypeManager.GetIconForType(imageKey, IconSize.IconSmall);
            }
            else
            {
                iconL = IconFunctions.IconFromBytes(entry.fileIcon);
                iconS = IconFunctions.IconFromBytes(entry.fileIcon);
            }
            
            if (iconL == null || iconS == null)
            {
                iconL = fTypeManager.GetIconForType("*file", IconSize.IconLarge);
                iconS = fTypeManager.GetIconForType("*file", IconSize.IconSmall);
            }

            if (AppSettingsManager.ShowHiddenWithDistinctRepresentation && (entry.isHidden || entry.isSystem))
            {
                imageKey = "*" + imageKey + "h";
                if (!lViewVFSBrowser.LargeImageList.Images.ContainsKey(imageKey))
                {
                    lViewVFSBrowser.LargeImageList.Images.Add(imageKey, GeneralMethods.SetImageOpacity(iconL.ToBitmap(), (float)0.5));
                    lViewVFSBrowser.SmallImageList.Images.Add(imageKey, GeneralMethods.SetImageOpacity(iconS.ToBitmap(), (float)0.5));
                }
            }
            else if (!lViewVFSBrowser.LargeImageList.Images.ContainsKey(imageKey))
            {
                lViewVFSBrowser.LargeImageList.Images.Add(imageKey, iconL.ToBitmap());
                lViewVFSBrowser.SmallImageList.Images.Add(imageKey, iconS.ToBitmap());
            }

            if (entry.isDir)
                tempExtendedListViewItem.Text = entry.name;
            else
            {
                if (AppSettingsManager.ShowExtensions)
                    tempExtendedListViewItem.Text = entry.name;
                else
                    Path.GetFileNameWithoutExtension(entry.name);
            }

            tempExtendedListViewItem.ImageKey = imageKey;
            tempExtendedListViewItem.UseItemStyleForSubItems = true;
            tempExtendedListViewItem.ToolTipText += "Type: " + ((entry.isDir) ? "File Folder" : fTypeManager.GetFileTypeInfo(Path.GetExtension(entry.name)).typeName);
            if (entry.size > 0)
                tempExtendedListViewItem.ToolTipText += Environment.NewLine + "Size: " + GeneralMethods.GetFormattedSize(entry.size);
            if (lViewVFSBrowser.View == View.Details)
            {
                foreach (ColumnHeader column in lViewVFSBrowser.Columns)
                {
                    if (column.Text == "File Size" && !entry.isDir)
                        tempExtendedListViewItem.SubItems.Add(GeneralMethods.GetFormattedSizeForColumn(entry.size));
                    else if (column.Text == "Type")
                        tempExtendedListViewItem.SubItems.Add(
                                ((entry.isDir) ? fTypeManager.GetFileTypeInfo("*dir").typeName :
                                fTypeManager.GetFileTypeInfo(Path.GetExtension(entry.name)).typeName));
                    else if (column.Text == "Date Modified")
                        tempExtendedListViewItem.SubItems.Add(entry.modified.ToString());
                    else if (column.Text == "Date Created")
                        tempExtendedListViewItem.SubItems.Add(entry.created.ToString());
                    else if (column.Text == "Date Accessed")
                        tempExtendedListViewItem.SubItems.Add(entry.accessed.ToString());
                    else if (column.Text == "Attrubutes")
                    {
                        string temp = "";
                        temp += (entry.isArch) ? "A" : "";
                        temp += (entry.isROnly) ? "R" : "";
                        temp += (entry.isSystem) ? "S" : "";
                        temp += (entry.isHidden) ? "H" : "";
                        temp += (entry.isCompressed) ? "C" : "";
                        temp += (entry.isEncrypted) ? "E" : "";

                        tempExtendedListViewItem.SubItems.Add(temp);
                    }
                    else if (column.Text == "Owner")
                        tempExtendedListViewItem.SubItems.Add(entry.owner);
                    else if (column.Text == "Author")
                        tempExtendedListViewItem.SubItems.Add(entry.author);
                    else if (column.Text == "Title")
                        tempExtendedListViewItem.SubItems.Add(entry.title);
                    else if (column.Text == "Subject")
                        tempExtendedListViewItem.SubItems.Add(entry.subject);
                    else if (column.Text == "Category")
                        tempExtendedListViewItem.SubItems.Add(entry.category);
                    else if (column.Text == "Pages")
                        tempExtendedListViewItem.SubItems.Add(entry.pages.ToString());
                    else if (column.Text == "Comments")
                        tempExtendedListViewItem.SubItems.Add(entry.comments);
                    else if (column.Text == "Artist")
                        tempExtendedListViewItem.SubItems.Add(entry.artist);
                    else if (column.Text == "Album")
                        tempExtendedListViewItem.SubItems.Add(entry.album);
                    else if (column.Text == "Album Year" && entry.albumYear > 1500)
                        tempExtendedListViewItem.SubItems.Add(entry.albumYear.ToString());
                    else if (column.Text == "Track Number")
                        tempExtendedListViewItem.SubItems.Add(entry.trackNo.ToString());
                    else if (column.Text == "Duration" && entry.trackDurtion > 0)
                        tempExtendedListViewItem.SubItems.Add((new TimeSpan(0, 0, (int)entry.trackDurtion)).ToString());
                    else if (column.Text == "Genre")
                        tempExtendedListViewItem.SubItems.Add(entry.genre);
                    else if (column.Text == "Bitrate" && entry.bitRate > 0)
                        tempExtendedListViewItem.SubItems.Add(GeneralMethods.GetFormattedBitrate(entry.bitRate));
                    else if (column.Text == "Sample Rate" && entry.sampleRate > 0)
                        tempExtendedListViewItem.SubItems.Add(entry.sampleRate.ToString() + "Hz");
                    else if (column.Text == "Frame Rate" && entry.frameRate > 0)
                        tempExtendedListViewItem.SubItems.Add(entry.frameRate.ToString() + " FPS");
                    else if (column.Text == "Dimensions" && (entry.width > 0 || entry.height > 0))
                        tempExtendedListViewItem.SubItems.Add(entry.width.ToString() + "x" + entry.height.ToString());
                    else if (column.Text == "Company")
                        tempExtendedListViewItem.SubItems.Add(entry.company);
                    else if (column.Text == "Description")
                        tempExtendedListViewItem.SubItems.Add(entry.description);
                    else if (column.Text == "File Version" && (entry.majorV + entry.minorV + entry.revision) > 0)
                        tempExtendedListViewItem.SubItems.Add(entry.majorV.ToString() + "." +
                            entry.minorV.ToString() + "." + entry.revision.ToString());
                    else if (column.Text == "Product Name")
                        tempExtendedListViewItem.SubItems.Add(entry.productName);
                    else if (column.Text == "Product Version" && (entry.majorPV + entry.minorPV + entry.pRevision) > 0)
                        tempExtendedListViewItem.SubItems.Add(entry.majorPV.ToString() + "." +
                            entry.minorPV.ToString() + "." + entry.pRevision.ToString());
                    else if (column.Text == "Copyright")
                        tempExtendedListViewItem.SubItems.Add(entry.copyright);
                    else if (column.Text != "Name")
                        tempExtendedListViewItem.SubItems.Add("");
                }
            }
            lViewVFSBrowser.Items.Add(tempExtendedListViewItem);
        }
        private void ImageListEntryProcessor(ListEntry entry)
        {
            ExtendedTreeNode tempTreeNode = new ExtendedTreeNode(ExtendedTreeNodeType.NodeTypeImage, entry.imageName, (object)entry);
            tempTreeNode.Name = entry.imageID.ToString();
            tempTreeNode.ImageIndex = 2;
            tempTreeNode.SelectedImageIndex = 1;
            
            tempTreeNode.ToolTipText = "Image Source: " + entry.imageSourcePath;
            tempTreeNode.ToolTipText += Environment.NewLine + "Volume Label: " + entry.imageSourceVolLabel;
            tempTreeNode.ToolTipText += Environment.NewLine + "File System: " + entry.imageSourceFileSystem;
            tempTreeNode.ToolTipText += Environment.NewLine + "Source Type: " + ((DriveType)entry.imageSourceDriveType).ToString();
            if (entry.imageDescription.Length > 0)
                tempTreeNode.ToolTipText += Environment.NewLine + "Image Description: " + entry.imageDescription;
            tempTreeNode.ContextMenuStrip = cMenuImageNode;

            if (entry.imageCategory == "")
            {
                treeImageBrowser.Nodes[1].Nodes.Add(tempTreeNode);
                return;
            }

            foreach (ExtendedTreeNode node in treeImageBrowser.Nodes[0].Nodes)
            {
                if (node.NodeType == ExtendedTreeNodeType.NodeTypeCategory)
                {
                    if (String.Compare(((ImageCategory)node.NodeData).categoryName, entry.imageCategory, true) == 0)
                    {
                        node.Nodes.Add(tempTreeNode);
                        return;
                    }
                }
            }

            treeImageBrowser.Nodes[2].Nodes.Add(tempTreeNode);
        }
        private void ShowPictureBox(string picturePath)
        {
            if (File.Exists(picturePath))
            {
                pBoxImagePicture.Image = Image.FromFile(picturePath);
                viewSplitter2.Panel2Collapsed = false;
            }
        }
        private void ClosePictureBox()
        {
            if (pBoxImagePicture.Image != null)
            {
                pBoxImagePicture.Image.Dispose();
                pBoxImagePicture.Image = null;
            }
            viewSplitter2.Panel2Collapsed = true;
        }
        private void UpdateBottomPanelImageInfo()
        {
            if (threadImageSourceDriveTypeQuerier != null)
                if (threadImageSourceDriveTypeQuerier.IsAlive)
                    threadImageSourceDriveTypeQuerier.Abort();

            threadImageSourceDriveTypeQuerier = new Thread(new ParameterizedThreadStart(ImageSourceDriveTypeQuerier));
            threadImageSourceDriveTypeQuerier.Start(globalImageListEntry);

            statusStripLblImageInfo.Text = globalImageListEntry.imageName;
            statusStripLblImageInfo.Text += Environment.NewLine + "Source: ";
            if (globalImageListEntry.imageSourcePath.Length > 50)
                statusStripLblImageInfo.Text += GeneralMethods.TruncatePathString(globalImageListEntry.imageSourcePath, 50);
            else
                statusStripLblImageInfo.Text += globalImageListEntry.imageSourcePath;
            if (globalImageListEntry.imageSourceVolLabel.Length > 0)
                statusStripLblImageInfo.Text += Environment.NewLine + "Volume Label: " + globalImageListEntry.imageSourceVolLabel;
            if (globalImageListEntry.imageDescription.Length > 0 && globalImageListEntry.imageDescription.Length < 50)
                statusStripLblImageInfo.Text += Environment.NewLine + "Description: " + globalImageListEntry.imageDescription;
            else if (globalImageListEntry.imageDescription.Length >= 50)
                statusStripLblImageInfo.Text += Environment.NewLine + "Description: " + globalImageListEntry.imageDescription.Substring(0, 47) + "...";
        }
        private void ImageSourceDriveTypeQuerier(object tempEntry)
        {
            ListEntry listEntry = (ListEntry)tempEntry;
            DriveInfo drvInfo = new DriveInfo(listEntry.imageSourcePath);
            Image imgOnline = Resources.unKnownOnline_64x64x32, imgOffline = Resources.unKnownOffline_64x64x32;

            switch ((DriveType)listEntry.imageSourceDriveType)
            {
                case DriveType.CDRom:
                    imgOnline = Resources.opticalDiskOnline_64x64x32;
                    imgOffline = Resources.opticalDiskOffline_64x64x32;
                    break;
                case DriveType.Fixed:
                    imgOnline = Resources.hardDiskOnline_64x64x32;
                    imgOffline = Resources.hardDiskOffline_64x64x32;
                    break;
                case DriveType.Network:
                    imgOnline = Resources.netDriveOnline_64x64x32;
                    imgOffline = Resources.netDriveOffline_64x64x32;
                    break;
                case DriveType.Removable:
                    imgOnline = Resources.removableDriveOnline_64x64x32;
                    imgOffline = Resources.removableDriveOffline_64x64x32;
                    break;
            }

            if (drvInfo.IsReady)
            {
                if (listEntry.imageSourceVolLabel == drvInfo.VolumeLabel)
                {
                    if (Directory.Exists(listEntry.imageSourcePath))
                    {
                        statusStripLblImageIcon.Image = (Image)imgOnline.Clone();
                        imageSourceOnline = true;
                    }
                    else
                    {
                        statusStripLblImageIcon.Image = (Image)imgOffline.Clone();
                        imageSourceOnline = false;
                    }
                }
                else
                {
                    statusStripLblImageIcon.Image = (Image)imgOffline.Clone();
                    imageSourceOnline = false;
                }
            }
            else
            {
                statusStripLblImageIcon.Image = (Image)imgOffline.Clone();
                imageSourceOnline = false;
            }
        }

        #endregion
    }

    internal class ExtendedTreeNode : TreeNode
    {
        private ExtendedTreeNodeType nodeType;
        private object nodeData;

        /// <summary>
        /// Gets or sets the type of this node. When setting to a new value, the value of NodeData property will be
        /// set to null and must be reinitialized according to the new type.
        /// </summary>
        public ExtendedTreeNodeType NodeType
        {
            get
            {
                return nodeType;
            }
            set
            {
                if (nodeType != value)
                    nodeData = null;
                nodeType = value;
            }
        }

        /// <summary>
        /// Gets or sets the data associated with this node.
        /// Throws an exception if the type of this node is set to NodeTypeUnknown.
        /// </summary>
        public Object NodeData
        {
            get { return nodeData; }
            set
            {
                if (nodeType == ExtendedTreeNodeType.NodeTypeUnknown)
                    throw new InvalidOperationException("NodeData cannot be assigned to when the NodeType property is set to NodeTypeUnknown");
                nodeData = value;
            }
        }

        public ExtendedTreeNode()
            : base()
        {
            nodeType = ExtendedTreeNodeType.NodeTypeUnknown;
            nodeData = null;
        }

        public ExtendedTreeNode(ExtendedTreeNodeType nodeType)
            : base()
        {
            this.nodeType = nodeType;
            this.nodeData = null;
        }

        public ExtendedTreeNode(ExtendedTreeNodeType nodeType, string text)
            : base(text)
        {
            this.nodeType = nodeType;
            this.nodeData = null;
        }

        public ExtendedTreeNode(ExtendedTreeNodeType nodeType, Object nodeData)
            : base()
        {
            this.nodeType = nodeType;
            this.nodeData = nodeData;
        }

        public ExtendedTreeNode(ExtendedTreeNodeType nodeType, string text, Object nodeData)
            : base(text)
        {
            this.nodeType = nodeType;
            this.nodeData = nodeData;
        }

        public ExtendedTreeNode(ExtendedTreeNodeType nodeType, TreeNode node, Object nodeData)
        {
            this.BackColor = node.BackColor;
            this.Checked = node.Checked;
            this.ContextMenu = node.ContextMenu;
            this.ContextMenuStrip = node.ContextMenuStrip;
            this.ForeColor = node.ForeColor;
            this.ImageIndex = node.ImageIndex;
            this.ImageKey = node.ImageKey;
            this.Name = node.Name;
            this.nodeData = nodeData;
            this.NodeFont = node.NodeFont;
            this.nodeType = nodeType;
            this.SelectedImageIndex = node.SelectedImageIndex;
            this.SelectedImageKey = node.SelectedImageKey;
            this.StateImageIndex = node.StateImageIndex;
            this.StateImageKey = node.StateImageKey;
            this.Tag = node.Tag;
            this.Text = node.Text;
            this.ToolTipText = node.ToolTipText;
        }
       
        public ExtendedTreeNode(ExtendedTreeNodeType nodeType, string text, int imageIndex, int selectedImageIndex)
            : base(text, imageIndex, selectedImageIndex)
        {
            this.nodeType = nodeType;
            this.nodeData = null;
        }

        public ExtendedTreeNode(ExtendedTreeNodeType nodeType, string text, int imageIndex, int selectedImageIndex, Object nodeData)
            : base(text, imageIndex, selectedImageIndex)
        {
            this.nodeType = nodeType;
            this.nodeData = nodeData;
        }

        public override object Clone()
        {
            ExtendedTreeNode newNode = new ExtendedTreeNode(this.nodeType, this.nodeData);

            newNode.BackColor = this.BackColor;
            newNode.Checked = this.Checked;
            newNode.ContextMenu = this.ContextMenu;
            newNode.ContextMenuStrip = this.ContextMenuStrip;
            newNode.ForeColor = this.ForeColor;
            if (this.ImageIndex > -1)
                newNode.ImageIndex = this.ImageIndex;
            else
                newNode.ImageKey = this.ImageKey;
            newNode.Name = this.Name;
            newNode.NodeFont = this.NodeFont;
            if (this.SelectedImageIndex > -1)
                newNode.SelectedImageIndex = this.SelectedImageIndex;
            else
                newNode.SelectedImageKey = this.SelectedImageKey;
            if (this.StateImageIndex > -1)
                newNode.StateImageIndex = this.StateImageIndex;
            else
                newNode.StateImageKey = this.StateImageKey;
            newNode.Tag = this.Tag;
            newNode.Text = this.Text;
            newNode.ToolTipText = this.ToolTipText;

            return newNode;
        }

        public override string ToString()
        {
            return "ExtendedTreeNode";
        }
    }

    internal enum ExtendedTreeNodeType
    {
        NodeTypeUnknown=0, NodeTypeImage, NodeTypeCategory, NodeTypeSuperCategory
    };

    internal class ExtendedListViewItem : ListViewItem
    {
        private VFSEntry itemVFSEntry;
        private ExtendedListViewItemType itemType;
        private UInt32 parentImageID;

        public VFSEntry ItemVFSEntry
        {
            get
            {
                return itemVFSEntry;
            }
            set
            {
                itemVFSEntry = value;
            }
        }

        public ExtendedListViewItemType ItemType
        {
            get
            {
                return itemType;
            }
            set
            {
                if (itemType != value)
                    parentImageID = 0;
                itemType = value;
            }
        }

        public UInt32 ParentImageID
        {
            get
            {
                return parentImageID;
            }
            set
            {
                parentImageID = value;
            }
        }

        public ExtendedListViewItem(ExtendedListViewItemType itemType)
            : base()
        {
            this.itemType = itemType;
        }

        public ExtendedListViewItem(ExtendedListViewItemType itemType, string text)
            : base(text)
        {
            this.itemType = itemType;
        }

        public ExtendedListViewItem(ExtendedListViewItemType itemType, string text, int imageIndex)
            : base(text, imageIndex)
        {
            this.itemType = itemType;
        }

        public ExtendedListViewItem(ExtendedListViewItemType itemType, string text, string imageKey)
            : base(text, imageKey)
        {
            this.itemType = itemType;
        }

        public ExtendedListViewItem(ExtendedListViewItemType itemType, VFSEntry entry)
            : base()
        {
            this.itemType = itemType;
            itemVFSEntry = entry;
        }

        public ExtendedListViewItem(ExtendedListViewItemType itemType, string text, VFSEntry entry)
            : base(text)
        {
            this.itemType = itemType;
            itemVFSEntry = entry;
        }

        public ExtendedListViewItem(ExtendedListViewItemType itemType, UInt32 parentImageID, string text, VFSEntry entry)
            : base(text)
        {
            this.itemType = itemType;
            this.parentImageID = parentImageID;
            itemVFSEntry = entry;
        }

        public ExtendedListViewItem(ExtendedListViewItemType itemType, string text, int imageIndex, VFSEntry entry)
            : base(text, imageIndex)
        {
            this.itemType = itemType;
            itemVFSEntry = entry;
        }

        public ExtendedListViewItem(ExtendedListViewItemType itemType, string text, string imageKey, VFSEntry entry)
            : base(text, imageKey)
        {
            this.itemType = itemType;
            itemVFSEntry = entry;
        }
    }

    internal enum ExtendedListViewItemType
    {
        ListViewItemTypeSearchResult=0, ListViewItemTypeVFSItem
    };
}